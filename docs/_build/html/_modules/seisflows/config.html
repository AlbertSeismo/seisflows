
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>seisflows.config &#8212; SeisFlows 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SeisFlows 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for seisflows.config</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># This is Seisflows</span>
<span class="c1">#</span>
<span class="c1"># See LICENCE file</span>
<span class="c1">#</span>
<span class="c1">###############################################################################</span>

<span class="c1"># Import system modules</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">copy_reg</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">copyreg</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>

<span class="c1"># Local imports (do not remove the ones that are not used!</span>
<span class="c1"># They do are when this file is imported from other files, which should be</span>
<span class="c1"># fixed I suppose)</span>
<span class="kn">from</span> <span class="nn">seisflows.tools</span> <span class="k">import</span> <span class="n">msg</span>
<span class="kn">from</span> <span class="nn">seisflows.tools.err</span> <span class="k">import</span> <span class="n">ParameterError</span>
<span class="kn">from</span> <span class="nn">seisflows.tools</span> <span class="k">import</span> <span class="n">unix</span>
<span class="kn">from</span> <span class="nn">seisflows.tools.tools</span> <span class="k">import</span> <span class="n">loadjson</span><span class="p">,</span> <span class="n">loadobj</span><span class="p">,</span> <span class="n">loadpy</span><span class="p">,</span> <span class="n">savejson</span><span class="p">,</span> <span class="n">saveobj</span>
<span class="kn">from</span> <span class="nn">seisflows.tools.tools</span> <span class="k">import</span> <span class="n">module_exists</span><span class="p">,</span> <span class="n">package_exists</span>

<span class="c1"># SeisFlows consists of interacting &#39;system&#39;, &#39;preprocess&#39;, &#39;solver&#39;,</span>
<span class="c1"># &#39;postprocess&#39;, &#39;optimize&#39;, and &#39;workflow&#39; objects. Each corresponds</span>
<span class="c1"># simultaneously to a module in the SeisFlows source code, a class that is</span>
<span class="c1"># instantiated and made accessible via sys.modules, and a parameter in a global</span>
<span class="c1"># dictionary. Once in memory, these objects can be thought of as comprising the</span>
<span class="c1"># complete &#39;state&#39; of a SeisFlows session</span>

<span class="c1"># The following list is one of the few hardwired aspects of the whole SeisFlows</span>
<span class="c1"># package. Any changes may result in circular imports or other problems</span>

<span class="c1"># There is one class corresponding to each of these names :</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;preprocess&#39;</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;postprocess&#39;</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">]</span>
<span class="c1"># They are instantiated in sys.modules[&#39;seisflows_&#39;+name]</span>

<div class="viewcode-block" id="config"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.config">[docs]</a><span class="k">def</span> <span class="nf">config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Instantiates SeisFlows objects and makes them globally accessible by</span>
<span class="sd">        registering them in sys.modules</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parameters and paths must already be loaded</span>
    <span class="c1"># (normally this is done by sfsubmit/sfrun)</span>
    <span class="k">assert</span> <span class="s1">&#39;seisflows_parameters&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
    <span class="k">assert</span> <span class="s1">&#39;seisflows_paths&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>

    <span class="c1"># Check if output directory already exist on disk</span>
    <span class="c1"># _output() return the path to the output folder where the results will</span>
    <span class="c1"># be stored</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">_output</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">WarningOverwrite</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># Instantiate and register objects (see comment at the top of the file)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">custom_import</span><span class="p">(</span><span class="n">name</span><span class="p">)()</span>

    <span class="c1"># Error checking</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_parameters&#39;</span><span class="p">],</span> <span class="s1">&#39;workflow&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">MissingParameter_Worfklow</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_parameters&#39;</span><span class="p">],</span> <span class="s1">&#39;system&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">MissingParameter_System</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Exports session to disk</span>
<span class="sd">        Write files:</span>
<span class="sd">        seisflows_parameters.json, seisflows_paths.json, seisflows_system.p,</span>
<span class="sd">        seisflows_preprocess.p, seisflows_solver.p, seisflows_postprocess.p,</span>
<span class="sd">        seisflows_optimize.p, seisflows_workflow.p</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unix</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">_output</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;paths&#39;</span><span class="p">]:</span>
        <span class="n">fullfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">_output</span><span class="p">(),</span> <span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
        <span class="n">savejson</span><span class="p">(</span><span class="n">fullfile</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">fullfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">_output</span><span class="p">(),</span> <span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">)</span>
        <span class="n">saveobj</span><span class="p">(</span><span class="n">fullfile</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">])</span></div>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Imports session from disk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;paths&#39;</span><span class="p">]:</span>
        <span class="n">fullfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">_full</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">loadjson</span><span class="p">(</span><span class="n">fullfile</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">fullfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">_full</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">loadobj</span><span class="p">(</span><span class="n">fullfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dict"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.Dict">[docs]</a><span class="k">class</span> <span class="nc">Dict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dictionary-like object for holding parameters or paths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Once defined, parameters cannot be changed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Once defined, parameters cannot be deleted.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyError</span>

<div class="viewcode-block" id="Dict.update"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.Dict.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newdict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Dict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="n">newdict</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define what happens when we print an object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">toDisplay</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">toDisplay</span> <span class="o">=</span> <span class="n">toDisplay</span> <span class="o">+</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot; : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">toDisplay</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newdict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">newdict</span><span class="p">)</span></div>


<div class="viewcode-block" id="Null"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.Null">[docs]</a><span class="k">class</span> <span class="nc">Null</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Always and reliably does nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="custom_import"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.custom_import">[docs]</a><span class="k">def</span> <span class="nf">custom_import</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Imports SeisFlows module and extracts class of same name. For example,</span>

<span class="sd">            custom_import(&#39;workflow&#39;, &#39;inversion&#39;)</span>

<span class="sd">        imports &#39;seisflows.workflow.inversion&#39; and, from this module, extracts</span>
<span class="sd">        class &#39;inversion&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse input arguments</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># No arguments given</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ImportError1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>  <span class="c1"># First arument is not a known module</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ImportError2</span><span class="p">)</span>
    <span class="c1"># If only one parameter is given (the module) we suppose that the class is</span>
    <span class="c1"># the one given in the parameter file, for example if the module asked is</span>
    <span class="c1"># &quot;solver&quot; (given as first argument) and that the parameter file contains</span>
    <span class="c1"># the line &#39;SOLVER&#39;: &#39;specfem2d&#39; we suppose that the class is specfem2d :</span>
    <span class="c1"># we append &quot;specfem2d&quot; to args</span>
    <span class="c1"># _try(&#39;SOLVER&#39;) returns the value associated with the key &#39;SOLVER&#39;</span>
    <span class="c1"># which is &#39;specfem2d&#39; in our example</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">_try</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),)</span>
    <span class="c1"># This happens when the value associated with the key is None:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">Null</span>

    <span class="c1"># Generate package list</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;seisflows&#39;</span><span class="p">]</span>

    <span class="c1"># Generate the corresponding module name and check if it exists</span>
    <span class="n">_exists</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
        <span class="n">full_dotted_name</span> <span class="o">=</span> <span class="n">package</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">module_exists</span><span class="p">(</span><span class="n">full_dotted_name</span><span class="p">):</span>
            <span class="n">_exists</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_exists</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ImportError3</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>

    <span class="c1"># Import the module full_dotted_name. For ex: seisflows.workflow.inversion</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">full_dotted_name</span><span class="p">)</span>

    <span class="c1"># Extract the correponding class contained in the module</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ImportError4</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="tilde_expand"><a class="viewcode-back" href="../../ref/seisflows.html#seisflows.config.tilde_expand">[docs]</a><span class="k">def</span> <span class="nf">tilde_expand</span><span class="p">(</span><span class="n">mydict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Expands tilde character in path strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;~/&#39;</span><span class="p">:</span>
            <span class="n">mydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">mydict</span></div>


<span class="c1"># Utility functions</span>


<span class="k">def</span> <span class="nf">_par</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_parameters&#39;</span><span class="p">][</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">_path</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the path corresponding to the key (given in paths.py)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;seisflows_paths&#39;</span><span class="p">][</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">_try</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_par</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_output</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Return the path to the output folder. Try to read it from</span>
<span class="sd">    seisflows_parameters. If not found return a path in current working</span>
<span class="sd">    directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_full</span><span class="p">(</span><span class="n">_path</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_full</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_full</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span>


<span class="c1"># The following code changes how instance methods are handled by pickle.</span>
<span class="c1"># Placing it here, in this module, ensures that pickle changes will be in</span>
<span class="c1"># effect for all SeisFlows workflows</span>
<span class="c1">#</span>
<span class="c1"># For relevant discussion, see stackoverflow thread</span>
<span class="c1"># &quot;Can&#39;t pickle &lt;type &#39;instancemethod&#39;&gt; when using python&#39;s</span>
<span class="c1"># multiprocessing Pool.map()&quot;</span>

<span class="k">def</span> <span class="nf">_pickle_method</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="n">func_name</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_func</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_self</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_class</span>
    <span class="k">return</span> <span class="n">_unpickle_method</span><span class="p">,</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_unpickle_method</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">copy_reg</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="n">_pickle_method</span><span class="p">,</span> <span class="n">_unpickle_method</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">copyreg</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="n">_pickle_method</span><span class="p">,</span> <span class="n">_unpickle_method</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SeisFlows 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, Princeton University.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>